#!/bin/bash

# Show Magic Trackpad monitoring status

# XDG Base Directory Specification
XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
DATA_DIR="$XDG_DATA_HOME/trackpad-monitor"

echo "=== Magic Trackpad Status ==="
echo

# Show monitored device
if [[ -f "$DATA_DIR/device-mac-cache" ]]; then
    MAC=$(cat "$DATA_DIR/device-mac-cache")
    echo "Monitored Device: $MAC"

    # Get device info
    if bluetoothctl info "$MAC" &>/dev/null; then
        NAME=$(bluetoothctl info "$MAC" | grep "Name:" | cut -d: -f2- | xargs)
        CONNECTED=$(bluetoothctl info "$MAC" | grep "Connected:" | awk '{print $2}')
        echo "Device Name: $NAME"
        echo "Currently Connected: $CONNECTED"
    fi
else
    echo "No device cached yet"
fi

echo

# Show last connected time
if [[ -f "$DATA_DIR/last-connected" ]]; then
    LAST_CONNECTED=$(cat "$DATA_DIR/last-connected")
    echo "Last Verified Connected: $LAST_CONNECTED"

    # Calculate time since
    TIMESTAMP=$(echo "$LAST_CONNECTED" | grep -oP '\(\K[0-9]+(?=\))')
    if [[ -n "$TIMESTAMP" ]]; then
        CURRENT=$(date +%s)
        SECONDS_AGO=$((CURRENT - TIMESTAMP))

        if [[ $SECONDS_AGO -lt 60 ]]; then
            echo "  (${SECONDS_AGO} seconds ago)"
        elif [[ $SECONDS_AGO -lt 3600 ]]; then
            echo "  ($((SECONDS_AGO / 60)) minutes ago)"
        else
            echo "  ($((SECONDS_AGO / 3600)) hours ago)"
        fi
    fi
else
    echo "Last Connected: Unknown"
fi

echo

# Show service status
echo "Service Status:"

# Check if service unit exists
SERVICE_FOUND=false
if systemctl --user list-unit-files magic-trackpad-monitor.service &>/dev/null | grep -q "magic-trackpad-monitor.service"; then
    SERVICE_FOUND=true
fi

if [ "$SERVICE_FOUND" = false ]; then
    echo "  ✗ Service not installed"
    echo
    echo "The magic-trackpad-monitor.service is not installed."
    echo
    echo "To install it:"
    echo "  1. Copy magic-trackpad-monitor.service to ~/.config/systemd/user/"
    echo "  2. Run: systemctl --user daemon-reload"
    echo "  3. Run: systemctl --user enable magic-trackpad-monitor.service"
    echo "  4. Run: systemctl --user start magic-trackpad-monitor.service"
    echo
    read -p "Would you like to install it now? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # Find the service file
        SERVICE_FILE=""
        for path in "/usr/lib/systemd/user/magic-trackpad-monitor.service" \
                    "/usr/local/share/magic-trackpad-monitor/magic-trackpad-monitor.service" \
                    "$(dirname "$0")/../share/magic-trackpad-monitor/magic-trackpad-monitor.service" \
                    "$(dirname "$0")/magic-trackpad-monitor.service"; do
            if [[ -f "$path" ]]; then
                SERVICE_FILE="$path"
                break
            fi
        done

        if [[ -n "$SERVICE_FILE" ]]; then
            mkdir -p ~/.config/systemd/user
            cp "$SERVICE_FILE" ~/.config/systemd/user/
            systemctl --user daemon-reload
            systemctl --user enable magic-trackpad-monitor.service
            systemctl --user start magic-trackpad-monitor.service
            echo "Service installed and started successfully!"
        else
            echo "Error: Could not find magic-trackpad-monitor.service file"
            echo "Please install the package or run the installer script"
        fi
    fi
else
    systemctl --user is-active magic-trackpad-monitor.service &>/dev/null
    if [[ $? -eq 0 ]]; then
        echo "  ✓ Running"
    else
        echo "  ✗ Not running"
        echo
        read -p "Would you like to start it now? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            systemctl --user start magic-trackpad-monitor.service
            echo "Service started successfully!"
        fi
    fi

    systemctl --user is-enabled magic-trackpad-monitor.service &>/dev/null
    if [[ $? -eq 0 ]]; then
        echo "  ✓ Enabled (starts on boot)"
    else
        echo "  ✗ Not enabled"
        echo
        read -p "Would you like to enable it? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            systemctl --user enable magic-trackpad-monitor.service
            echo "Service enabled successfully!"
        fi
    fi
fi

echo
echo "Cache expiry: 30 days"
if [[ -f "$DATA_DIR/device-mac-cache" ]]; then
    CACHE_AGE_DAYS=$(( ($(date +%s) - $(stat -c %Y "$DATA_DIR/device-mac-cache")) / 86400 ))
    echo "Cache age: ${CACHE_AGE_DAYS} days"
fi
